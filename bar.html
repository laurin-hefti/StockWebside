<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title> Bar </title>

    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


    <style>
        :root {
            --background-color: black;
            --text-color: white;
        }

        h1 {
            color: var(--text-color);
            text-align: center;
        }

        button {
            margin: 5px;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .drinkElement {
            color: var(--text-color);
            margin: 15px;
        }

        .drinkmodifybutton {
            margin: 5px;
            width: 30px;
        }

        .drinkmodifybutton:hover{
            background-color: gray;
        }
    </style>
</head>

<body style = "background-color: var(--background-color);">
    <h1 class="conatiner mt-5">Bar</h1>

    <div class="conatiner mt-5">
        <button class="btn btn-dark" id="homeLink">home</button>
        <button class="btn btn-dark" id="dataLink">Settings</button>
        <button class="btn btn-dark" id="statisticLink">statistics</button>
        <button class="btn btn-dark" id="chartSideLink">Chart</button>
    </div>

    <!--content the page-->
    <div class="container mt-4">
        <div id="homeContent">
            <h1>Bar menu</h1>
            <div style="display: flex;">
                <div id="drinkOptionList" style="width: 600px;"></div> <!--my display flex-->
                <div>
                    <h3 class="drinkElement" id="summDisplayElement">sum : 0</h3>
                    <button class="btn btn-dark" id="gesamtRechnungResetButton">reset</button>
                </div>
            </div>
        </div>

        <div id="dataContent">
            <h1>Settings</h1>
            <div> <!--style="border: 1px solid gray; margin : 10px;"-->
                <button class="btn btn-dark" id="newTimeButton">Abrechnen</button>
                <button class="btn btn-dark" id="newLoadButton">Seite neu Laden</button>
                <button class="btn btn-dark" id="randomData">random Daten generieren</button>
                <button class="btn btn-dark" id="targetPrice">Target Price : </button>
                <button class="btn btn-dark" id="loadDrinks">Laod Drink Chart</button>
                <button class="btn btn-dark" id="changeDrinkChart">Drink Chart</button>
                <button class="btn btn-dark" id="relativePrice">Relative Price</button>
                <button class="btn btn-dark" id="styleMode">change Style mode</button>
            </div>
            <div id="drinkSettingsList"></div>
        </div>

        <div id="statisticContent">
            <h1>statistics</h1>
            <div id="drinkStatisticList"></div>
        </div>

        <div id="chartSide">
            <iframe src="http://localhost:3000" width="100%" height="1000px"></iframe>
        </div>

    </div>

    <script>
        async function sendToStockServer(input_data, func){
            await fetch("http://localhost:3003", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(input_data)
            }).then(response => {
                if (!response.ok){
                    console.log("error with getting data from 3003");
                    alert("error at port 3003");
                } else {
                    return response.json();
                }
            }).then(data => {
                func(data);
            });
        }

        const eventSorce = new EventSource("/events");
        eventSorce.onmessage = function(data){
            console.log(data.data);
            if (data.data == "reload"){
                location.reload();
            }
        }

        function setTargetButton(data){
            let button = document.getElementById("targetPrice");
            button.textContent = "Target Price : " + data.data;
        }

        function setRelativePriceButton(data){
            let button = document.getElementById("relativePrice");
            button.textContent = "Relativ Price : " + data.data;
        }

        function setChangeDrinkButton(data){
            let button = document.getElementById("changeDrinkChart");
            button.textContent = "Drink Chart : " + data.data;
        }

        function round(num, fac){
            let f = Math.pow(10,fac);
            return Math.round(num * f) / f;
        }

        $(document).ready(function() {
            $("#dataContent").hide();
            $("#statisticContent").hide();
            $("#chartSide").hide();

            sendToStockServer("getPriceMode", setTargetButton);
            sendToStockServer("getDrinkPath", setChangeDrinkButton);
            sendToStockServer("getRelativPriceMode", setRelativePriceButton);

            let sumdispalyelement = document.getElementById("summDisplayElement");
            let current_sum_p = localStorage.getItem("currentPrice");
            if (current_sum_p === null || Number.isNaN(parseFloat(current_sum_p))){
                current_sum_p = 0;
                localStorage.setItem("currentPrice", 0);
            }
            sumdispalyelement.textContent = "sum : " + current_sum_p;

            $("#homeLink").click(function(){
                $("#homeContent").show();
                $("#dataContent").hide();
                $("#statisticContent").hide();
                $("#chartSide").hide();
            });

            $("#dataLink").click(function() {
                $("#dataContent").show();
                $("#homeContent").hide();
                $("#statisticContent").hide();
                $("#chartSide").hide();
            });

            $("#statisticLink").click(function() {
                $("#statisticContent").show();
                $("#dataContent").hide();
                $("#homeContent").hide();
                $("#chartSide").hide();
            });

            $("#chartSideLink").click(function(){
                $("#chartSide").show();
                $("#statisticContent").hide();
                $("#dataContent").hide();
                $("#homeContent").hide();
            })

            $("#newTimeButton").click(function(){
                sendToStockServer("newTimeStamp", (data)=>{});
            });

            $("#randomData").click(function () {
                if (confirm("daten wirklich generieren")){
                    sendToStockServer("randomData", (data)=>{});
                }
            });

            $("#newLoadButton").click(function(){
                location.reload();
            });

            $("#targetPrice").click(function() {
                sendToStockServer("setPTMode", ()=>{});
                sendToStockServer("getPriceMode", setTargetButton);
            });

            $("#relativePrice").click(function() {
                sendToStockServer("setRPMode", ()=>{});
                sendToStockServer("getRelativPriceMode", setRelativePriceButton);
            })

            $("#loadDrinks").click(function(){
                sendToStockServer("loadDrinkList", ()=>{});
            });

            $("#changeDrinkChart").click(function(){
                sendToStockServer("changeDrinkPath", setChangeDrinkButton);
            });

            $("#styleMode").click(function(){
                sendToStockServer("changeStyle", ()=>{});
            });

            $("#gesamtRechnungResetButton").click(function(){
                var sumdispalyelement = document.getElementById("summDisplayElement");
                sumdispalyelement.textContent = "sum : 0";
                localStorage.setItem("currentPrice", 0);
            });

            async function setDrinkData(){
                await fetch("http://localhost:3001").then(response => {
                    if (!response.ok) {
                        console.log("error with receaving data form 3001");
                        alert("error from the server with data from port 3001");
                    } else {
                        return response.json();
                    }
                }).then(data =>{
                    var dl = document.getElementById("drinkOptionList");
                    //var sumdispalyelement = document.getElementById("summDispalyElement");

                    data.drinks.forEach(element => {
                        let drinkdiv = document.createElement("h3");
                        
                        // display name and price of every drink
                        drinkdiv.classList.add("drinkElement");
                        drinkdiv.textContent = element.name + " " + element.prices[element.prices.length-1];
                        dl.appendChild(drinkdiv);

                        // create the buttons to modyfy the drink
                        let buttonadddrink = document.createElement("div");
                        buttonadddrink.textContent = "+";
                        buttonadddrink.classList.add("drinkmodifybutton");
                        buttonadddrink.addEventListener("click", function() {
                            var sumdispalyelement = document.getElementById("summDisplayElement");
                            var num = parseFloat(sumdispalyelement.textContent.split(":")[1])
                            let new_p =  (num + element.prices[element.prices.length-1]);
                            sumdispalyelement.textContent = "sum : " + new_p;
                            localStorage.setItem("currentPrice", new_p);
                            sendToStockServer("buy," + element.name, (data)=>{});});
                        drinkdiv.appendChild(buttonadddrink);
                    
                        let buttonremovedrink = document.createElement("div");
                        buttonremovedrink.textContent = "-";
                        buttonremovedrink.classList.add("drinkmodifybutton");
                        buttonremovedrink.addEventListener("click", function() {
                            var sumdispalyelement = document.getElementById("summDisplayElement");
                            var num = parseFloat(sumdispalyelement.textContent.split(":")[1]);
                            let new_p =  (num - element.prices[element.prices.length-1]);
                            sumdispalyelement.textContent = "sum : " + new_p;
                            localStorage.setItem("currentPrice", new_p);
                            sendToStockServer("sell,"+element.name, (data)=>{});});
                        drinkdiv.appendChild(buttonremovedrink);
                    });
                });
            }

            async function setDrinkSettings(){
                async function processData(data){
                    let settingsdiv = document.getElementById("drinkSettingsList");
                    for (let drink of data.drinks){
                        let drinkdiv = document.createElement("h3");
                        drinkdiv.textContent = drink.name;
                        drinkdiv.classList.add("drinkElement");
                        settingsdiv.appendChild(drinkdiv);
                        
                        let mindiv = document.createElement("h3");
                        mindiv.textContent = "min Price : " + drink.minPrice;
                        mindiv.classList.add("drinkElement");
                        drinkdiv.appendChild(mindiv);

                        let maxdiv = document.createElement("h3");
                        maxdiv.textContent = "max Price : " + drink.maxPrice;
                        maxdiv.classList.add("drinkElement");
                        drinkdiv.appendChild(maxdiv);

                        let targetDiv = document.createElement("h3");
                        targetDiv.textContent = "target Price : " + drink.targetPrice;
                        targetDiv.classList.add("drinkElement");
                        drinkdiv.appendChild(targetDiv);

                    }
                }

                await sendToStockServer("getJsonSetings", processData);
            }

            async function setDrinkStatistics(){
                async function processData(data){
                    let statisticsdiv = document.getElementById("drinkStatisticList");
                    for(let drink of data.drinks){
                        let drinkdiv = document.createElement("h3");
                        drinkdiv.textContent = drink.name;
                        drinkdiv.classList.add("drinkElement");
                        statisticsdiv.appendChild(drinkdiv);

                        let total_sales = document.createElement("h3");
                        total_sales.textContent = "verkauft : " + drink.totalSels;
                        total_sales.classList.add("drinkElement");
                        drinkdiv.appendChild(total_sales);

                        let durchschnit_verkauft = round(drink.totalMony / drink.totalSels,2);
                        if (drink.totalSels == 0){
                            durchschnit_verkauft = 0;
                        }
                        let ratio = document.createElement("h3");
                        ratio.textContent = "durchschnit StÃ¼ckpreis : " + durchschnit_verkauft;
                        ratio.classList.add("drinkElement");
                        drinkdiv.appendChild(ratio); 
                    }
                }

                await sendToStockServer("getJsonStatistics", processData);
            }

            //making a function
            setDrinkData().then(() => setDrinkSettings()).then(() => setDrinkStatistics());
        });
    </script>
</body>